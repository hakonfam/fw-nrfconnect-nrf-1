#
# Copyright (c) 2020 Nordic Semiconductor ASA
#
# SPDX-License-Identifier: LicenseRef-Nordic-5-Clause
#

menu "Partition Manager"

config PARTITION_MANAGER_ENABLED
	bool "Partition manager is enabled (read-only option)"
	help
	  Option which can be checked to see whether or not the
	  partition manager is enabled in the current build. Note that this
	  should ideally be a hidden option, but it can't due to limitations
	  in how parent images impose options on child images. Don't
	  change the value of this option.

# Override this option to use custom flash map implementation when partition
# manager is enabled.
config FLASH_MAP_CUSTOM
	bool
	default y
	depends on PARTITION_MANAGER_ENABLED

# These values are now set by partition manager, so hide the option.
config SRAM_SIZE
	int
	depends on !PARTITION_MANAGER_ENABLED

# These values are now set by partition manager, so hide the option.
config SRAM_BASE_ADDRESS
	hex
	depends on !PARTITION_MANAGER_ENABLED

menu "Zephyr subsystem configurations"

if FILE_SYSTEM_LITTLEFS
partition=LITTLEFS
partition-size=0x6000
rsource "Kconfig.template.partition_size"
endif


if SETTINGS
partition=SETTINGS_STORAGE
partition-size=0x2000
rsource "Kconfig.template.partition_size"
endif

if NVS && !SETTINGS_NVS
partition=NVS_STORAGE
partition-size=0x6000
rsource "Kconfig.template.partition_size"
endif

if ZIGBEE && !SOC_NRF52833
partition=ZBOSS_NVRAM
partition-size=0x8000
rsource "Kconfig.template.partition_size"
endif

if ZIGBEE && SOC_NRF52833
partition=ZBOSS_NVRAM
partition-size=0x4000
rsource "Kconfig.template.partition_size"
endif

if ZIGBEE
partition=ZBOSS_PRODUCT_CONFIG
partition-size=0x1000
rsource "Kconfig.template.partition_size"
endif

endmenu # Zephyr subsystem configurations


menu "Zephyr samples configurations"

if BT_RPMSG_NRF53 && SOC_NRF5340_CPUAPP
module=HCI_RPMSG
source "${ZEPHYR_BASE}/../nrf/subsys/partition_manager/Kconfig.template.build_strategy_domain"

DT_CHOSEN_Z_IPC_SHM := zephyr,ipc_shm

config RPMSG_NRF53_SRAM_SIZE
	# Hidden configuration to expose DT property as kconfig variable
	hex
	default "$(dt_chosen_reg_size_hex,$(DT_CHOSEN_Z_IPC_SHM))"

endif

endmenu # Zephyr samples configurations

menu "NCS subsystem configurations"

endmenu # NCS subsystem configurations

menu "NCS samples configurations"

if NRF_802154_SER_HOST && SOC_NRF5340_CPUAPP
module=802154_RPMSG
source "${ZEPHYR_BASE}/../nrf/subsys/partition_manager/Kconfig.template.build_strategy_domain"
endif

if BT_RPC && SOC_NRF5340_CPUAPP
module=RPC_HOST
source "${ZEPHYR_BASE}/../nrf/subsys/partition_manager/Kconfig.template.build_strategy_domain"

DT_CHOSEN_Z_IPC_SHM := zephyr,ipc_shm

config BT_RPC_HOST_NRF53_SRAM_SIZE
	# Hidden configuration to expose DT property as kconfig variable
	hex
	default "$(dt_chosen_reg_size_hex,$(DT_CHOSEN_Z_IPC_SHM))"

endif

endmenu # NCS samples configurations

config PM_SINGLE_IMAGE
	bool "Use the Partition Manager for single image builds" if !BUILD_WITH_TFM
	default y if BUILD_WITH_TFM
	select PARTITION_MANAGER_ENABLED
	help
	  Use the Partition Manager feature to partition the device even if
	  only a single image is included in the build. This is typically set
	  when a subsystem that defines its own Partition Manager configuration
	  is included in the build.

	  The option is always defined in builds where a TF-M image for the
	  Secure Execution environment is generated.

config PM_EXTERNAL_FLASH
	bool "Support external flash in Partition Manager"
	depends on PM_EXTERNAL_FLASH_DEV_NAME != ""
	depends on PM_EXTERNAL_FLASH_SIZE != 0
	depends on PM_EXTERNAL_FLASH_XSPI_MEM_MAPPED_ADDRESS != 0

config PM_EXTERNAL_FLASH_DEV_NAME
	string "Name of the external flash device"
	default "MX25R64" if BOARD_NRF5340DK_NRF5340_CPUAPP || BOARD_NRF5340DK_NRF5340_CPUAPP_NS
	default "MX25R64" if BOARD_THINGY53_NRF5340_CPUAPP || BOARD_THINGY53_NRF5340_CPUAPPNS
	default "MX25R64" if BOARD_NRF52840DK_NRF52840
	default ""
	help
	  Must match the 'drv_name' argument used when initializing the
	  driver for the external flash through the 'DEVICE...INIT'
	  function call. The value is used when calling 'device_get_binding'.

config PM_EXTERNAL_FLASH_SIZE
	hex "External flash size (in bytes)"
	default 0x200000 if BOARD_NRF5340DK_NRF5340_CPUAPP || BOARD_NRF5340DK_NRF5340_CPUAPP_NS
	default 0x200000 if BOARD_THINGY53_NRF5340_CPUAPP || BOARD_THINGY53_NRF5340_CPUAPPNS
	default 0x200000 if BOARD_NRF52840DK_NRF52840
	default 0

config PM_EXTERNAL_FLASH_BASE
	hex "External flash base address"
	default 0

config PM_EXTERNAL_FLASH_XSPI_MEM_MAPPED_ADDRESS
	hex "Address for the QSPI interface connected to the external flash"
	default 0x10000000 if BOARD_NRF5340DK_NRF5340_CPUAPP || BOARD_NRF5340DK_NRF5340_CPUAPP_NS
	default 0x10000000 if BOARD_THINGY53_NRF5340_CPUAPP || BOARD_THINGY53_NRF5340_CPUAPPNS
	default 0x12000000 if BOARD_NRF52840DK_NRF52840
	default 0  # This indicates that the value is not set
	help
	  See 'Memory Map' chapter in product specification. This value is only
	  used when generating hex files which can be flashed directly to the
	  secondary slot.

config PM_PARTITION_SIZE_MCUBOOT_SECONDARY
	hex "Size of MCUboot secondary partition"
	default 0
	depends on PM_EXTERNAL_FLASH
	help
	  Must be set to the same size as the 'MCUBOOT_PRIMARY' partition.

config PM_EXTERNAL_FLASH_MCUBOOT_SECONDARY
	bool "Locate secondary slot of MCUboot in external flash"
	depends on PM_EXTERNAL_FLASH
	depends on PM_PARTITION_SIZE_MCUBOOT_SECONDARY != 0
	help
	  Place the secondary partition of MCUboot in the external flash instead
	  of the internal flash.

config PM_IMAGE_NOT_BUILT_FROM_SOURCE
	bool
	help
	  Promptless helper config used to indicate that one or more
	  image is not built from source.

# Helper configs needed since 'SRAM_SIZE/BASE' use the chosen node.
config PM_SRAM_BASE
	hex
	default $(dt_node_reg_addr_hex,/soc/memory@21000000) if SOC_NRF5340_CPUNET
	default $(dt_node_reg_addr_hex,/soc/memory@20000000)

config PM_SRAM_SIZE
	hex
	default $(dt_node_reg_size_hex,/soc/memory@21000000) if SOC_NRF5340_CPUNET
	default $(dt_node_reg_size_hex,/soc/memory@20000000)

endmenu # Partition Manager
